@page
@model IndexModel
@{
    ViewData["Title"] = "Home";
}

<section>
    <h1 class="neon-title">Alien Moltbook console</h1>
    <p class="sub">
        Razor Pages front door for your local LM Studio agent + Moltbook identity verification.
    </p>

    <div class="hero-cards">
        <div class="card glow">
            <h2>LM Studio</h2>
            <p>Base URL: <code>http://localhost:1234/v1</code></p>

            <button class="btn-neo" type="button" onclick="pingLmStudio()">Ping /v1/models</button>
            <pre id="lmstudioOut" class="out">// output…</pre>
        </div>

        <div class="card glow2">
            <h2>API</h2>
            <p>Check your backend health endpoint.</p>

            <button class="btn-neo cyan" type="button" onclick="pingApi()">Ping /api/health</button>
            <pre id="apiOut" class="out">// output…</pre>
        </div>
    </div>

    <div class="card" style="margin-top:14px;">
        <h2>Test a Prompt</h2>
        <textarea id="prompt" class="input-neo" rows="5" placeholder="Ask the agent something…"></textarea>
        <div style="margin-top:10px;">
            <button class="btn-neo" type="button" onclick="sendPrompt()">Send</button>
        </div>
        <pre id="chatOut" class="out">// response…</pre>
    </div>

    <button class="btn-neo cyan" type="button" id="joinBtn">Join Moltbook</button>
    <pre id="joinOut" class="out">// claim link will show here…</pre>

    <div class="card glow2" style="margin-top:14px;">
        <h2>Moltbook State</h2>
        <p>
            <strong>Handle:</strong> <code>@(Model.Moltbook?.ClaimUrl)</code>{
            <a href="@Model.Moltbook!.ClaimUrl" target="_blank">@Model.Moltbook!.ClaimUrl</a>
            }
            else{
            <code>(none)</code>
            }
        </p>

        <p><strong>API Key (masked):</strong> <code>@IndexModel.Mask(Model.Moltbook?.AgentApiKey)</code></p>

        <p><strong>Last heartbeat (UTC): </strong> <code>@(Model.Moltbook?.LastHeartbeatUtc?.ToString("u") ?? "(none)")</code></p>

        <button class="btn btn-neo cyan" type="button" onclick="refreshState()">Refresh State</button>
        <pre id="stateOut" class="out">// state refresh output...</pre>
    </div>

    <div class="card glow2" style="margin-top:14px;">
        <h2>Heartbeats</h2>
        <button class="btn-neo" type="button" id="heartbeatBtn">Run Heartbeat</button>
        <pre id="heartbeatOut" class="out">// heartbeat output will show here…</pre>
    </div>

    <div class="card glow2" style="margin-top:14px;">
        <h2>Compose from Feed</h2>

        <div style="display:grid; gap:10px;">
            <label>
                Submolt
                <input id="composeSubmolt" class="input-neo" placeholder="m/algtrading" value="m/algtrading" />
            </label>

            <label>
                How many posts to read
                <input id="composeTake" class="input-neo" type="number" min="1" max="50" value="15" />
            </label>

            <label>
                User prompt / context (mixed into the draft)
                <textarea id="composeContext" class="input-neo" rows="4"
                          placeholder="What should the agent focus on? Tone? Facts you want to include?"></textarea>
            </label>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-neo" type="button" onclick="composePreview()">Read + Draft</button>
                <button class="btn-neo cyan" type="button" onclick="composePublish()">Post Draft</button>
            </div>

            <h3 style="margin:6px 0 0 0;">Preview / Debug</h3>
            <pre id="composePreviewOut" class="out">// fetched posts + statuses...</pre>

            <h3 style="margin:6px 0 0 0;">Draft (editable)</h3>
            <textarea id="composeDraft" class="input-neo" rows="8"
                      placeholder="Draft will appear here... (you can edit before posting)">
            </textarea>

            <pre id="composePublishOut" class="out">// publish status...</pre>

        </div>
    </div>

</section>



@section Scripts {
    <script>
        async function pingLmStudio() {
          const out = document.getElementById('lmstudioOut');
          out.textContent = 'Loading…';
          try {
            const r = await fetch('http://localhost:1234/v1/models');
            out.textContent = await r.text();
          } catch (e) {
            out.textContent = 'Error: ' + e;
          }
        }

        async function pingApi() {
          const out = document.getElementById('apiOut');
          out.textContent = 'Loading…';
          try {
            const r = await fetch('/api/health');
            out.textContent = await r.text();
          } catch (e) {
            out.textContent = 'Error: ' + e;
          }
        }

        async function sendPrompt() {
          const out = document.getElementById('chatOut');
          const prompt = document.getElementById('prompt').value;
          out.textContent = 'Thinking…';
          try {
            const r = await fetch('/api/agent/think', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt })
            });
            out.textContent = await r.text();
          } catch (e) {
            out.textContent = 'Error: ' + e;
          }
        }

        document.getElementById('joinBtn').addEventListener('click', async () => {
          const out = document.getElementById('joinOut');
          out.textContent = 'Generating claim link…';
          try {
            const r = await fetch('/api/moltbook/join', {
              method: 'POST'
            });
            out.textContent = await r.text();
          } catch (e) {
            out.textContent = 'Error: ' + e;
          }
        });

        document.getElementById('joinBtn').addEventListener('click', async () => {
          const out = document.getElementById('joinOut');
          out.textContent = 'Generating claim link…';

          try {
            const r = await fetch('/api/moltbook/join', { method: 'POST' });
            out.textContent = await r.text();

            await refreshState();
          } catch (e) {
            out.textContent = 'Error: ' + e;
          }
        });

        async function refreshState() {
          const out = document.getElementById('stateOut');
          out.textContent = 'Loading…';
          try {
            const r = await fetch('/api/moltbook/state');
            out.textContent = await r.text();
          } catch (e) {
            out.textContent = 'Error: ' + e;
          }
        }

        document.getElementById('heartbeatBtn').addEventListener('click', async () => {
          const out = document.getElementById('heartbeatOut');
          out.textContent = 'Running heartbeat…';
          try {
            const r = await fetch('/api/moltbook/heartbeat', { method: 'POST' });
            out.textContent = await r.text();
            if(typeof refreshState === 'function') {
              await refreshState();
            }
          } catch (e) {
            out.textContent = 'Error: ' + e;
          }
        });
    </script>
}
